Plan: CLI Orchestrator for Multi-Agent Parallel Execution │ │ │ │ Context │ │ │ │ Open-Inspect runs
coding agents in isolated Modal sandboxes, one session per task. Currently each session is
independent — no higher-level coordination exists. We want a CLI tool (oi) that decomposes a
high-level goal │ │ into sub-tasks, executes them in parallel across multiple sandboxes, and merges
the results. │ │ │ │ The user runs a single command: │ │ oi orchestrate --repo owner/repo "Refactor
auth to use JWT" │ │ │ │ This plans, approves, executes in parallel, merges, and creates a PR — all
in one interactive flow. │ │ │ │ Key Design Decisions │ │ │ │ - State: CLI-side only (local JSON at
~/.open-inspect/projects/) │ │ - Auth: Direct HMAC via INTERNAL_CALLBACK_SECRET (same as web→control
plane) │ │ - Monitoring: Poll GET /sessions/:id every 5s (no WebSocket complexity) │ │ - No control
plane changes — the CLI uses existing endpoints │ │ │ │ Patterns Borrowed from Dicklesworthstone
Ecosystem │ │ │ │
┌───────────────────────────────────┬──────────────────────────────────┬────────────────────────────────────────────────────────────────┐
│ │ │ Pattern │ Source │ How We Use It │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Parallel execution tracks │ Beads Viewer --robot-plan │ DAG categorized into parallel "waves"
for display │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ File scope as conflict prevention │ MCP Agent Mail file reservations │ Planner assigns glob
scopes; minimizes merge conflicts │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Coordination via prompt │ Claude Code Agent Farm │ Worker agents get context about sibling
tasks in their prompt │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Robot mode JSON convention │ NTM/bv/cass ecosystem │ CLI --json flag outputs structured JSON
on stdout │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Work-stealing queue │ Repo Updater │ Ready tasks pulled from queue as slots open (not
pre-assigned) │ │ │
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Meaningful exit codes │ Repo Updater │ 0=success, 1=partial, 2=merge-failed, 3=plan-failed │ │
│
├───────────────────────────────────┼──────────────────────────────────┼────────────────────────────────────────────────────────────────┤
│ │ │ Fail-open philosophy │ DCG │ Polling failures don't abort — retry with backoff │ │ │
└───────────────────────────────────┴──────────────────────────────────┴────────────────────────────────────────────────────────────────┘
│ │ │ │ New Package: packages/cli/ │ │ │ │ packages/cli/ │ │ ├── package.json │ │ ├── tsconfig.json
│ │ └── src/ │ │ ├── index.ts # Entry point, commander setup │ │ ├── commands/ │ │ │ ├──
orchestrate.ts # Main command (plan → approve → execute → integrate) │ │ │ ├── config.ts #
`oi config set/get` for setup │ │ │ └── status.ts # `oi status <id>` to check/resume a project │ │
├── api/ │ │ │ └── client.ts # Authenticated control plane client │ │ ├── orchestrator/ │ │ │ ├──
planner.ts # Phase 1: create planner session, parse JSON plan │ │ │ ├── approver.ts # Phase 2:
display plan, interactive approve/edit/reject │ │ │ ├── executor.ts # Phase 3: DAG walk, parallel
session management │ │ │ ├── integrator.ts # Phase 4: merge session, PR creation │ │ │ └── dag.ts #
DAG validation, topological sort, wave computation │ │ ├── state/ │ │ │ ├── config.ts #
~/.open-inspect/config.json read/write │ │ │ ├── project.ts # Project state persistence (atomic
writes) │ │ │ └── types.ts # ProjectState, TaskNode, TaskExecution interfaces │ │ ├── prompts/ │ │ │
├── planner.ts # Planner system prompt │ │ │ ├── worker.ts # Per-task worker prompt (with dep
context) │ │ │ └── integrator.ts # Merge/integration prompt │ │ ├── ui/ │ │ │ ├── plan-display.ts #
Render plan table + DAG waves │ │ │ ├── progress.ts # Live execution progress (in-place table
redraw) │ │ │ └── logger.ts # chalk-based structured output │ │ └── util/ │ │ ├──
json-extractor.ts # Extract JSON from agent text output │ │ └── retry.ts # Exponential backoff with
jitter │ │ │ │ Dependencies │ │ │ │ { │ │ "dependencies": { │ │ "@open-inspect/shared":
"file:../shared", │ │ "chalk": "^5.4.1", │ │ "commander": "^13.1.0", │ │ "ora": "^8.2.0" │ │ }, │ │
"devDependencies": { │ │ "@types/node": "^22.10.5", │ │ "typescript": "^5.7.2" │ │ } │ │ } │ │ │ │
Data Model │ │ │ │ Project State (~/.open-inspect/projects/<id>.json) │ │ │ │ interface ProjectState
{ │ │ id: string; // nanoid │ │ createdAt: number; │ │ updatedAt: number; │ │ goal: string; //
Original user goal │ │ repo: { owner: string; name: string }; │ │ phase: "planning" | "approval" |
"executing" | "integrating" | "completed" | "failed"; │ │ │ │ planning: { │ │ sessionId: string |
null; │ │ model: string; │ │ status: "pending" | "running" | "completed" | "failed"; │ │ error?:
string; │ │ }; │ │ │ │ plan: { │ │ summary: string; │ │ tasks: TaskNode[]; │ │ } | null; │ │ │ │
tasks: Record<string, TaskExecution>; // Keyed by task ID │ │ │ │ integration: { │ │ sessionId:
string | null; │ │ status: "pending" | "running" | "completed" | "failed"; │ │ mergedBranch: string
| null; │ │ prUrl: string | null; │ │ error?: string; │ │ }; │ │ } │ │ │ │ interface TaskNode { │ │
id: string; // "task-1", "task-2", etc. │ │ title: string; │ │ description: string; // Detailed
enough for agent to implement │ │ fileScope: string[]; // Glob patterns │ │ dependsOn: string[]; //
Task IDs │ │ complexity: "small" | "medium" | "large"; │ │ } │ │ │ │ interface TaskExecution { │ │
taskId: string; │ │ status: "pending" | "running" | "completed" | "failed" | "skipped"; │ │
sessionId: string | null; │ │ branchName: string | null; │ │ startedAt: number | null; │ │
completedAt: number | null; │ │ summary: string | null; │ │ error: string | null; │ │ retryCount:
number; │ │ } │ │ │ │ CLI Config (~/.open-inspect/config.json) │ │ │ │ interface CliConfig { │ │
controlPlaneUrl: string; │ │ internalCallbackSecret: string; │ │ defaultModel?: string; // Default
for worker tasks │ │ plannerModel?: string; // Default for planning (opus recommended) │ │
maxParallelSessions?: number; // Default: 3 │ │ } │ │ │ │ The Four Phases │ │ │ │ Phase 1: Planning
│ │ │ │ 1. Create session via POST /sessions with the target repo │ │ 2. Send planner prompt via
POST /sessions/:id/prompt │ │ 3. Poll until execution_complete event │ │ 4. Extract JSON plan from
token events (using json-extractor.ts) │ │ 5. Validate plan: check for cycles (Tarjan's), validate
task IDs, verify dependsOn references │ │ │ │ Planner prompt instructs the agent to: │ │ - Explore
the codebase first (read files, understand architecture) │ │ - Decompose the goal into independent
sub-tasks with file scopes │ │ - Minimize dependencies (maximize parallelism) │ │ - Output a
structured JSON plan in a
`json code fence                                                                                                                                                                       │ │                                                                                                                                                                                                                               │ │ Model: Use opus-4-5 for planning (configurable). Planning quality is critical.                                                                                                                                                │ │                                                                                                                                                                                                                               │ │ Phase 2: Approval                                                                                                                                                                                                             │ │                                                                                                                                                                                                                               │ │ Display to user:                                                                                                                                                                                                              │ │ Tasks (4):                                                                                                                                                                                                                    │ │   #  Deps  Title                      Scope                   Size                                                                                                                                                            │ │   1  -     JWT token utilities         src/auth/**             medium                                                                                                                                                         │ │   2  1     Auth middleware migration    src/middleware/auth.ts   medium                                                                                                                                                       │ │   3  1     API route handler updates   src/routes/**           large                                                                                                                                                          │ │   4  2,3   Update test suite           tests/**                medium                                                                                                                                                         │ │                                                                                                                                                                                                                               │ │ Execution waves:                                                                                                                                                                                                              │ │   Wave 1: task-1                                                                                                                                                                                                              │ │   Wave 2: task-2, task-3  (parallel)                                                                                                                                                                                          │ │   Wave 3: task-4                                                                                                                                                                                                              │ │                                                                                                                                                                                                                               │ │ ? Approve plan? (Y)es / (e)dit in $EDITOR / (r)eject:                                                                                                                                                                         │ │                                                                                                                                                                                                                               │ │ If edit: write plan JSON to temp file, open $EDITOR, read back, re-validate.                                                                                                                                                  │ │                                                                                                                                                                                                                               │ │ Phase 3: Execution                                                                                                                                                                                                            │ │                                                                                                                                                                                                                               │ │ Algorithm (work-stealing pattern from Repo Updater):                                                                                                                                                                          │ │                                                                                                                                                                                                                               │ │ while (pending or running tasks exist):                                                                                                                                                                                       │ │   ready = tasks where status=pending AND all deps completed                                                                                                                                                                   │ │   slots = maxParallel - running.count                                                                                                                                                                                         │ │   spawn min(ready.count, slots) sessions                                                                                                                                                                                      │ │                                                                                                                                                                                                                               │ │   sleep 5 seconds                                                                                                                                                                                                             │ │   for each running task:                                                                                                                                                                                                      │ │     poll GET /sessions/:id                                                                                                                                                                                                    │ │     if not processing:                                                                                                                                                                                                        │ │       fetch events, find execution_complete                                                                                                                                                                                   │ │       mark completed or failed                                                                                                                                                                                                │ │       persist state                                                                                                                                                                                                           │ │                                                                                                                                                                                                                               │ │   if failed tasks and no running:                                                                                                                                                                                             │ │     prompt user: retry / skip / abort                                                                                                                                                                                         │ │                                                                                                                                                                                                                               │ │ Each worker session gets a prompt with:                                                                                                                                                                                       │ │ - The task description                                                                                                                                                                                                        │ │ - File scope constraints                                                                                                                                                                                                      │ │ - Context from completed dependencies (summaries + branch names)                                                                                                                                                              │ │ - Instruction to NOT merge other branches, work from default branch                                                                                                                                                           │ │                                                                                                                                                                                                                               │ │ State persisted after every mutation — safe to Ctrl+C and resume with oi status <id>.                                                                                                                                         │ │                                                                                                                                                                                                                               │ │ Phase 4: Integration                                                                                                                                                                                                          │ │                                                                                                                                                                                                                               │ │ 1. Create a merge session with the same repo                                                                                                                                                                                  │ │ 2. Send integration prompt listing all completed task branches                                                                                                                                                                │ │ 3. Agent merges branches one at a time, resolves conflicts, runs tests                                                                                                                                                        │ │ 4. If tests pass, offer to create PR                                                                                                                                                                                          │ │ 5. If tests fail, show error, offer retry                                                                                                                                                                                     │ │                                                                                                                                                                                                                               │ │ Files to Create/Modify                                                                                                                                                                                                        │ │                                                                                                                                                                                                                               │ │ New Files (all in packages/cli/)                                                                                                                                                                                              │ │                                                                                                                                                                                                                               │ │ ┌────────────────────────────────┬──────────────────────────────────────────────────────────────────────────┐                                                                                                                 │ │ │              File              │                                 Purpose                                  │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ package.json                   │ Package config with deps                                                 │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ tsconfig.json                  │ TypeScript config extending root                                         │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/index.ts                   │ CLI entry, commander setup with orchestrate, config, status commands     │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/commands/orchestrate.ts    │ Main command wiring all 4 phases                                         │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/commands/config.ts         │ oi config set controlPlaneUrl <url> etc.                                 │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/commands/status.ts         │ oi status <id> — show project state, option to resume                    │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/api/client.ts              │ ControlPlaneClient class (mirrors packages/web/src/lib/control-plane.ts) │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/orchestrator/planner.ts    │ Create planner session, poll, extract plan                               │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/orchestrator/approver.ts   │ Interactive plan review                                                  │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/orchestrator/executor.ts   │ DAG walking execution loop                                               │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/orchestrator/integrator.ts │ Merge session + PR                                                       │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/orchestrator/dag.ts        │ Topological sort, cycle detection, wave computation                      │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/state/config.ts            │ Config file I/O                                                          │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/state/project.ts           │ Project state I/O (atomic writes)                                        │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/state/types.ts             │ TypeScript interfaces                                                    │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/prompts/planner.ts         │ Planner prompt template                                                  │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/prompts/worker.ts          │ Worker prompt template (with dep context injection)                      │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/prompts/integrator.ts      │ Merge prompt template                                                    │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/ui/plan-display.ts         │ Plan table + wave rendering                                              │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/ui/progress.ts             │ Live execution progress table                                            │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/ui/logger.ts               │ Structured colored output                                                │                                                                                                                 │ │ ├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤                                                                                                                 │ │ │ src/util/json-extractor.ts     │ Extract JSON from `json
fences or raw text │ │ │
├────────────────────────────────┼──────────────────────────────────────────────────────────────────────────┤
│ │ │ src/util/retry.ts │ Retry with exponential backoff + jitter │ │ │
└────────────────────────────────┴──────────────────────────────────────────────────────────────────────────┘
│ │ │ │ Existing Files to Reference (not modify) │ │ │ │
┌───────────────────────────────────────┬───────────────────────────────────────────────────┐ │ │ │
File │ What We Reuse │ │ │
├───────────────────────────────────────┼───────────────────────────────────────────────────┤ │ │ │
packages/shared/src/auth.ts │ generateInternalToken() for HMAC auth │ │ │
├───────────────────────────────────────┼───────────────────────────────────────────────────┤ │ │ │
packages/shared/src/types.ts │ CreateSessionRequest, Session, SandboxEvent, etc. │ │ │
├───────────────────────────────────────┼───────────────────────────────────────────────────┤ │ │ │
packages/shared/src/models.ts │ VALID_MODELS, isValidModel(), model display info │ │ │
├───────────────────────────────────────┼───────────────────────────────────────────────────┤ │ │ │
packages/web/src/lib/control-plane.ts │ Pattern for controlPlaneFetch() wrapper │ │ │
└───────────────────────────────────────┴───────────────────────────────────────────────────┘ │ │ │
│ Root File to Modify │ │ │ │
┌──────────────┬──────────────────────────────────────────────────────────────────────────────┐ │ │
│ File │ Change │ │ │
├──────────────┼──────────────────────────────────────────────────────────────────────────────┤ │ │
│ package.json │ Already has "workspaces": ["packages/*"] — no change needed, auto-discovered │ │ │
└──────────────┴──────────────────────────────────────────────────────────────────────────────┘ │ │
│ │ Implementation Order │ │ │ │ 1. Scaffolding: package.json, tsconfig.json, src/index.ts, config
command, CliConfig types │ │ 2. API Client: client.ts with authenticated fetch, session CRUD, event
fetching │ │ 3. State Management: config.ts, project.ts, types.ts — read/write with atomic file ops
│ │ 4. Planning Phase: planner.ts prompt, json-extractor.ts, planner orchestration │ │ 5. DAG +
Approval: dag.ts (topo sort, cycles, waves), plan-display.ts, approver.ts │ │ 6. Execution Phase:
executor.ts (the core loop), worker.ts prompt, progress.ts UI │ │ 7. Integration Phase:
integrator.ts prompt + orchestration │ │ 8. Wiring: orchestrate.ts command connecting all phases,
status.ts command │ │ 9. Polish: Error messages, --json flag, --dry-run flag, --resume flag │ │ │ │
Verification │ │ │ │ 1. Unit test: Run oi config set controlPlaneUrl <url> and verify
~/.open-inspect/config.json │ │ 2. Integration test: Run oi orchestrate --repo <test-repo> --dry-run
"Add a README" — should plan but not execute │ │ 3. End-to-end test: Run oi orchestrate --repo
<test-repo> "Add error handling to the API endpoints" against a real repo with the control plane
running │ │ 4. Resume test: Start an orchestration, Ctrl+C during execution, run oi status <id>,
verify state is accurate, run oi orchestrate --resume <id> to continue │ │ 5. Build verification:
npm run build in packages/cli/, then node dist/index.js --help
